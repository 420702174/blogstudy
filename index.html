<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>学习笔记</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="学习笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="学习笔记">
<meta property="og:url" content="http://420702174.github.io/index.html">
<meta property="og:site_name" content="学习笔记">
<meta property="og:description" content="学习笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="zq">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/blogstudy/atom.xml" title="学习笔记" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/blogstudy/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/blogstudy/css/style.css">

  
    
<link rel="stylesheet" href="/blogstudy/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/blogstudy/" id="logo">学习笔记</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/blogstudy/">Home</a>
        
          <a class="main-nav-link" href="/blogstudy/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/blogstudy/atom.xml" title="RSS 订阅"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://420702174.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-类加载机制" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/blogstudy/%5Bobject%20Object%5D/%5Bobject%20Object%5D/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" class="article-date">
  <time class="dt-published" datetime="2021-11-29T14:11:10.000Z" itemprop="datePublished">2021-11-29</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/blogstudy/categories/Java/">Java</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/blogstudy/%5Bobject%20Object%5D/%5Bobject%20Object%5D/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/">类加载机制</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="类加载全过程"><a href="#类加载全过程" class="headerlink" title="类加载全过程"></a>类加载全过程</h2><img src="/blogstudy/%5Bobject%20Object%5D/%5Bobject%20Object%5D/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.png" class="" title="类加载流程">

<p>其中 loadClass 方法类加载包含以下几步</p>
<blockquote>
<p><strong>加载&gt;&gt;验证&gt;&gt;准备&gt;&gt;解析&gt;&gt;初始化</strong></p>
</blockquote>
<blockquote>
<p><strong>加载：</strong>在硬盘上查找并通过 IO 读取字节码文件，在内存中生成<strong>代表当前类的 java.lang.Class 对象</strong>，作为方法区这个类的各种数据的访问入口</p>
</blockquote>
<blockquote>
<p><strong>验证：</strong>验证字节码文件的正确性</p>
</blockquote>
<blockquote>
<p><strong>准备：</strong>给静态变量分配内存空间并赋默认值</p>
</blockquote>
<blockquote>
<p><strong>解析：</strong>将符号引用替换为直接引用，该阶段会把一些静态方法(符号引用，比如 main()方法)替换为指向数据所存内存的指针或句柄等(直接引用)，这是所谓的静态链接过程(类加载期间完成)，动态链接是在程序运行期间完成的将符号引用替换为直接引用</p>
</blockquote>
<blockquote>
<p><strong>初始化：</strong>静态变量初始化为指定的值，执行静态代码块</p>
</blockquote>
<hr>
<p>类被加载到方法区中主要包含：<strong>运行时常量池，类型信息，方法信息，字段信息，类加载器引用，对应 Class 实例的引用</strong></p>
<blockquote>
<p><strong>类加载器引用：</strong>当前类的类加载器引用</p>
</blockquote>
<blockquote>
<p><strong>对应 Class 实例的引用：</strong>类加载器加载类信息到方法区后，会创建一个对应 Class 类型的对象实例放在堆中(Heap)</p>
</blockquote>
<hr>
<h4 id="主类在运行过程中如果使用到其他类，会逐步加载这些类，jar-包或-war-包里的类不是一次性加载的，而是使用到才会加载"><a href="#主类在运行过程中如果使用到其他类，会逐步加载这些类，jar-包或-war-包里的类不是一次性加载的，而是使用到才会加载" class="headerlink" title="主类在运行过程中如果使用到其他类，会逐步加载这些类，jar 包或 war 包里的类不是一次性加载的，而是使用到才会加载"></a>主类在运行过程中如果使用到其他类，会逐步加载这些类，jar 包或 war 包里的类不是一次性加载的，而是使用到才会加载</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class Test &#123;</span><br><span class="line"></span><br><span class="line">  static &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;********load Test********&quot;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">    A a = new A();</span><br><span class="line"></span><br><span class="line">    B b = null;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class A &#123;</span><br><span class="line"></span><br><span class="line">  static &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;*******load A*******&quot;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public A() &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;********init A*********&quot;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class B &#123;</span><br><span class="line"></span><br><span class="line">  static &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;*******load B*******&quot;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public B() &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;********init B*********&quot;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"></span><br><span class="line">********load Test********</span><br><span class="line"></span><br><span class="line">*******load A*******</span><br><span class="line"></span><br><span class="line">********init A*********</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="类加载器和双亲委派机制"><a href="#类加载器和双亲委派机制" class="headerlink" title="类加载器和双亲委派机制"></a>类加载器和双亲委派机制</h3><h6 id="Java-中类加载器有如下几种："><a href="#Java-中类加载器有如下几种：" class="headerlink" title="Java 中类加载器有如下几种："></a>Java 中类加载器有如下几种：</h6><ul>
<li><p>引导类加载器（BootstrapClassLoader）：负责加载支持 JVM 运行时位于 JRE lib 目录下的的核心类库如 rt.jar,charsets.jar 等</p>
</li>
<li><p>扩展类加载器（ExtClassLoader）: 负责加载支持 JVM 运行时位于 JRE ext 扩展目录下的 jar 包</p>
</li>
<li><p>应用程序加载器（AppClassLoader）：负责加载用户自定义目录下的类</p>
</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class TestJDKClassLoader &#123;</span><br><span class="line"></span><br><span class="line">  public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(String.class.getClassLoader());</span><br><span class="line"></span><br><span class="line">    System.out.println(</span><br><span class="line"></span><br><span class="line">      com.sun.crypto.provider.DESKeyFactory.class.getClassLoader()</span><br><span class="line"></span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    System.out.println(TestJDKClassLoader.class.getClassLoader());</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;===================================&quot;);</span><br><span class="line"></span><br><span class="line">    ClassLoader appClassLoader = ClassLoader.getSystemClassLoader();</span><br><span class="line"></span><br><span class="line">    ClassLoader extClassLoader = appClassLoader.getParent();</span><br><span class="line"></span><br><span class="line">    ClassLoader bootstrapClassLoader = extClassLoader.getParent();</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;the appClassLoader: &quot; + appClassLoader);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;the extClassLoader: &quot; + extClassLoader);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;the bootstrapClassLoader: &quot; + bootstrapClassLoader);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;=================================&quot;);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;bootstrapClassLoader加载一下文件路径: &quot;);</span><br><span class="line"></span><br><span class="line">    URL[] urLs = Launcher.getBootstrapClassPath().getURLs();</span><br><span class="line"></span><br><span class="line">    Arrays.stream(urLs).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;extClassLoader 加载一下文件路径: &quot;);</span><br><span class="line"></span><br><span class="line">    System.out.println(System.getProperty(&quot;java.ext.dirs&quot;));</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;appClassLoader 加载一下文件路径: &quot;);</span><br><span class="line"></span><br><span class="line">    System.out.println(System.getProperty(&quot;java.class.path&quot;));</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;==============================================&quot;);</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"></span><br><span class="line">null</span><br><span class="line"></span><br><span class="line">sun.misc.Launcher$ExtClassLoader@4554617c</span><br><span class="line"></span><br><span class="line">sun.misc.Launcher$AppClassLoader@75b84c92</span><br><span class="line"></span><br><span class="line">===================================</span><br><span class="line"></span><br><span class="line">the appClassLoader: sun.misc.Launcher$AppClassLoader@75b84c92</span><br><span class="line"></span><br><span class="line">the extClassLoader: sun.misc.Launcher$ExtClassLoader@4554617c</span><br><span class="line"></span><br><span class="line">the bootstrapClassLoader: null</span><br><span class="line"></span><br><span class="line">=================================</span><br><span class="line"></span><br><span class="line">bootstrapClassLoader加载一下文件路径:</span><br><span class="line"></span><br><span class="line">file:/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/resources.jar</span><br><span class="line"></span><br><span class="line">file:/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/rt.jar</span><br><span class="line"></span><br><span class="line">file:/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/sunrsasign.jar</span><br><span class="line"></span><br><span class="line">file:/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/jsse.jar</span><br><span class="line"></span><br><span class="line">file:/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/jce.jar</span><br><span class="line"></span><br><span class="line">file:/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/charsets.jar</span><br><span class="line"></span><br><span class="line">file:/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/jfr.jar</span><br><span class="line"></span><br><span class="line">file:/usr/lib/jvm/java-8-openjdk-amd64/jre/classes</span><br><span class="line"></span><br><span class="line">extClassLoader 加载一下文件路径:</span><br><span class="line"></span><br><span class="line">/usr/lib/jvm/java-8-openjdk-amd64/jre/lib/ext:/usr/java/packages/lib/ext</span><br><span class="line"></span><br><span class="line">appClassLoader 加载一下文件路径:</span><br><span class="line"></span><br><span class="line">.</span><br><span class="line"></span><br><span class="line">==============================================</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h6 id="类加载器初始化过程解析："><a href="#类加载器初始化过程解析：" class="headerlink" title="类加载器初始化过程解析："></a>类加载器初始化过程解析：</h6><p>参见类运行加载全过程图可知，C++代码创建 JVM 启动器实例 sun.misc.Launcher。</p>
<p>Launcher 类构造方法中创建了扩展类加载器（ExtClassLoader）和应用程序类加载器（AppClassLoader）</p>
<p>JVM 默认使用 Launcher.getClassLoader()方法获取的应用程序类加载器来加载我们的应用程序</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//Launcher类构造器</span><br><span class="line"></span><br><span class="line">    public Launcher() &#123;</span><br><span class="line">        Launcher.ExtClassLoader var1;</span><br><span class="line">        try &#123;</span><br><span class="line">            var1 = Launcher.ExtClassLoader.getExtClassLoader();</span><br><span class="line">        &#125; catch (IOException var10) &#123;</span><br><span class="line">            throw new InternalError(&quot;Could not create extension class loader&quot;, var10);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            this.loader = Launcher.AppClassLoader.getAppClassLoader(var1);</span><br><span class="line">        &#125; catch (IOException var9) &#123;</span><br><span class="line">            throw new InternalError(&quot;Could not create application class loader&quot;, var9);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Thread.currentThread().setContextClassLoader(this.loader);</span><br><span class="line">        String var2 = System.getProperty(&quot;java.security.manager&quot;);</span><br><span class="line">        if (var2 != null) &#123;</span><br><span class="line">            SecurityManager var3 = null;</span><br><span class="line">            if (!&quot;&quot;.equals(var2) &amp;&amp; !&quot;default&quot;.equals(var2)) &#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    var3 = (SecurityManager)this.loader.loadClass(var2).newInstance();</span><br><span class="line">                &#125; catch (IllegalAccessException var5) &#123;</span><br><span class="line">                &#125; catch (InstantiationException var6) &#123;</span><br><span class="line">                &#125; catch (ClassNotFoundException var7) &#123;</span><br><span class="line">                &#125; catch (ClassCastException var8) &#123;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                var3 = new SecurityManager();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            if (var3 == null) &#123;</span><br><span class="line">                throw new InternalError(&quot;Could not create SecurityManager: &quot; + var2);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            System.setSecurityManager(var3);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">//Launcher getClassLoader方法 获取AppClassLoader</span><br><span class="line">    public ClassLoader getClassLoader() &#123;</span><br><span class="line">        return this.loader;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h6 id="JVM-双亲委派机制"><a href="#JVM-双亲委派机制" class="headerlink" title="JVM 双亲委派机制"></a>JVM 双亲委派机制</h6><p>类加载器之间有亲子关系</p>
<img src="/blogstudy/%5Bobject%20Object%5D/%5Bobject%20Object%5D/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/%E5%8F%8C%E4%BA%B2%E5%A7%94%E6%B4%BE%E6%9C%BA%E5%88%B6.png" class="" title="双亲委派机制">

<blockquote>
<p>双亲委派机制会先调用 findLoadedClass(name);查找当前类加载器是否已经加载过当前类，如果没有加载过，会直接委派父类加载器加载，父类加载器查找是否加载过当前类，如果没有加载过，会继续委派父类加载如此反复，直到当前类加载器没有父类加载器，会直接调用引导类加载器加载当前类（c = findBootstrapClassOrNull(name)）如果加载失败，会让下级子类加载器加载当前类。</p>
</blockquote>
<h5 id="简单来说，双亲委派就是先由父类加载器加载，父类加载器加载不到，再由子类加载器加载"><a href="#简单来说，双亲委派就是先由父类加载器加载，父类加载器加载不到，再由子类加载器加载" class="headerlink" title="简单来说，双亲委派就是先由父类加载器加载，父类加载器加载不到，再由子类加载器加载"></a>简单来说，双亲委派就是先由父类加载器加载，父类加载器加载不到，再由子类加载器加载</h5><p>以下是应用类加载器双亲委派源码：</p>
<ol>
<li><p>findLoadedClass(name) 查找是否已经加载过当前类，加载过直接返回</p>
</li>
<li><p>没有加载过，判断是否含有父类加载器，有的话调用 c = parent.loadClass(name, false);委派父类加载，没有调用引导类加载器 c = findBootstrapClassOrNull(name);加载</p>
</li>
<li><p>父类类加载器没有加载到，调用 c = findClass(name)由子类类加载器</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">//name 为加载类的全类名</span><br><span class="line"></span><br><span class="line">protected Class&lt;?&gt; loadClass(String name, boolean resolve)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="为什么设计双亲委派机制"><a href="#为什么设计双亲委派机制" class="headerlink" title="为什么设计双亲委派机制"></a>为什么设计双亲委派机制</h4><ul>
<li><p>沙箱安全机制：防止核心类库被随意篡改</p>
</li>
<li><p>避免类的重复加载：父类加载过的类，子类不需要重复加载，保证了加载类的唯一性</p>
</li>
</ul>
<p><strong>沙箱安全机制示例</strong></p>
<blockquote>
<p> 双亲委派向上委派由引导类加载器加载 JRE lib 中的 String 类，自己实现的 java.lang.String 类未被应用程序类加载器加载</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">package java.lang;</span><br><span class="line"></span><br><span class="line">public class String &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">    System.out.println(&quot;================MyString Load=================&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">运行结果：</span><br><span class="line"></span><br><span class="line">    错误: 在类 java.lang.String 中找不到 main 方法, 请将 main 方法定义为: public static void main(String[] args) 否则 JavaFX 应用程序类必须扩展javafx.application.Application</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>全盘负责委托机制</strong></p>
<p>“<strong>全盘负责</strong>”是指当一个 ClassLoder 装载一个类时，除非显示的使用另外一个 ClassLoder，该类所依赖及引用的类也由这个 ClassLoder 载入。</p>
<h5 id="自定义类加载器示例"><a href="#自定义类加载器示例" class="headerlink" title="自定义类加载器示例"></a>自定义类加载器示例</h5><blockquote>
<p>实现自定义类加载器分为两步：</p>
<ol>
<li> 继承 ClassLoader 类                                                                                        </li>
<li> 重写 findClass 方法</li>
</ol>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">public class MyClassLoaderTest extends ClassLoader &#123;</span><br><span class="line"></span><br><span class="line">    private String classPath;</span><br><span class="line"></span><br><span class="line">    public MyClassLoaderTest(String classPath) &#123;</span><br><span class="line">        this.classPath = classPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private byte[] loadByte(String name) throws Exception &#123;</span><br><span class="line">        name = name.replaceAll(&quot;\\.&quot;, &quot;/&quot;);</span><br><span class="line">        FileInputStream fis = new FileInputStream(classPath + &quot;/&quot; + name + &quot;.class&quot;);</span><br><span class="line">        int len = fis.available();</span><br><span class="line">        byte[] data = new byte[len];</span><br><span class="line">        fis.read(data);</span><br><span class="line">        fis.close();</span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] data = loadByte(name);</span><br><span class="line">            //defineClass将一个字节数组转为Class对象，这个字节数组是class文件读取后最终的字节 数组。</span><br><span class="line">            return defineClass(name, data, 0, data.length);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            throw new ClassNotFoundException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    public static void main(String args[]) throws Exception &#123;</span><br><span class="line">        //初始化自定义类加载器，会先初始化父类ClassLoader，其中会把自定义类加载器的父加载 器设置为应用程序类加载器AppClassLoader</span><br><span class="line">        MyClassLoaderTest classLoader = new MyClassLoaderTest(&quot;D:/test&quot;);  //D盘创建 test/com/zq/jvm 几级目录，将User类的复制类User1.class丢入该目录</span><br><span class="line">        Class clazz = classLoader.loadClass(&quot;com.zq.jvm.User1&quot;);</span><br><span class="line">        Object obj = clazz.newInstance();</span><br><span class="line">        Method method = clazz.getDeclaredMethod(&quot;sout&quot;, null);</span><br><span class="line">        method.invoke(obj, null);</span><br><span class="line">        System.out.println(clazz.getClassLoader().getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>打破双亲委派机制</strong></p>
<blockquote>
<p>再来一个沙箱安全机制示例，尝试打破双亲委派机制，用自定义类加载器加载我们自己的类，重写 loadClass 类，对自己实现的类直接加载，不进行双亲委派</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">import java.io.FileInputStream;</span><br><span class="line">import java.lang.reflect.Method;</span><br><span class="line"></span><br><span class="line">public class MyClassLoaderTest extends ClassLoader &#123;</span><br><span class="line"></span><br><span class="line">    private String classPath;</span><br><span class="line"></span><br><span class="line">    public MyClassLoaderTest(String classPath) &#123;</span><br><span class="line">        this.classPath = classPath;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private byte[] loadByte(String name) throws Exception &#123;</span><br><span class="line">        name = name.replaceAll(&quot;\\.&quot;, &quot;/&quot;);</span><br><span class="line">        FileInputStream fis = new FileInputStream(classPath + &quot;/&quot; + name + &quot;.class&quot;);</span><br><span class="line">        int len = fis.available();</span><br><span class="line">        byte[] data = new byte[len];</span><br><span class="line">        fis.read(data);</span><br><span class="line">        fis.close();</span><br><span class="line">        return data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            byte[] data = loadByte(name);</span><br><span class="line">            //defineClass将一个字节数组转为Class对象，这个字节数组是class文件读取后最终的字节 数组。</span><br><span class="line">            return defineClass(name, data, 0, data.length);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            throw new ClassNotFoundException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException &#123;</span><br><span class="line">        synchronized (getClassLoadingLock(name)) &#123;</span><br><span class="line">            // First, check if the class has already been loaded</span><br><span class="line">            Class&lt;?&gt; c = findLoadedClass(name);</span><br><span class="line"></span><br><span class="line">            if (c == null) &#123;</span><br><span class="line">                // If still not found, then invoke findClass in order</span><br><span class="line">                // to find the class.</span><br><span class="line">                long t1 = System.nanoTime();</span><br><span class="line">                //非自定义的类还是走双亲委派加载</span><br><span class="line">                if (!name.startsWith(&quot;com.zq.jvm&quot;)) &#123;</span><br><span class="line">                    c = this.getParent().loadClass(name);</span><br><span class="line">                &#125; else &#123;</span><br><span class="line">                    c = findClass(name);</span><br><span class="line">                &#125;</span><br><span class="line">                // this is the defining class loader; record the stats</span><br><span class="line">                sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1);</span><br><span class="line">                sun.misc.PerfCounter.getFindClasses().increment();</span><br><span class="line">            &#125;</span><br><span class="line">            if (resolve) &#123;</span><br><span class="line">                resolveClass(c);</span><br><span class="line">            &#125;</span><br><span class="line">            return c;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String args[]) throws Exception &#123;</span><br><span class="line">        MyClassLoaderTest classLoader = new MyClassLoaderTest(&quot;D:/test&quot;);</span><br><span class="line">        Class clazz = classLoader.loadClass(&quot;com.zq.jvm.User1&quot;);</span><br><span class="line">        Object obj = clazz.newInstance();</span><br><span class="line">        Method method = clazz.getDeclaredMethod(&quot;sout&quot;, null);</span><br><span class="line">        method.invoke(obj, null);</span><br><span class="line">        System.out.println(clazz.getClassLoader().getClass().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">运行结果：</span><br><span class="line">        ======自己的加载器加载类调用方法======= </span><br><span class="line">        com.tuling.jvm.MyClassLoaderTest$MyClassLoader@266474c2</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://420702174.github.io/[object%20Object]/[object%20Object]/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/" data-id="ckwutgdwk0000fsui9fik6d5e" data-title="类加载机制" class="article-share-link">分享</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/blogstudy/tags/JVM/" rel="tag">JVM</a></li></ul>

    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/blogstudy/categories/Java/">Java</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/blogstudy/tags/JVM/" rel="tag">JVM</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/blogstudy/tags/JVM/" style="font-size: 10px;">JVM</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/blogstudy/archives/2021/11/">十一月 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/blogstudy/%5Bobject%20Object%5D/%5Bobject%20Object%5D/%E7%B1%BB%E5%8A%A0%E8%BD%BD%E6%9C%BA%E5%88%B6/">类加载机制</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 zq<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/blogstudy/" class="mobile-nav-link">Home</a>
  
    <a href="/blogstudy/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/blogstudy/js/jquery-3.4.1.min.js"></script>



  
<script src="/blogstudy/fancybox/jquery.fancybox.min.js"></script>




<script src="/blogstudy/js/script.js"></script>





  </div>
</body>
</html>